<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TXTSubAlign - éŸ³é¢‘æ–‡æœ¬å¯¹é½å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #000000;
            color: #ffffff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 32px;
            font-weight: 600;
            border-bottom: 2px solid #ffffff;
            padding-bottom: 20px;
        }

        /* æŠ˜å é¢æ¿æ ·å¼ */
        .collapsible {
            background-color: #1a1a1a;
            border: 1px solid #333333;
            margin-bottom: 20px;
        }

        .collapsible-header {
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }

        .collapsible-header:hover {
            background-color: #222222;
        }

        .collapsible-header h3 {
            font-size: 16px;
            font-weight: 500;
        }

        .collapsible-icon {
            font-size: 14px;
            transition: transform 0.2s;
        }

        .collapsible.active .collapsible-icon {
            transform: rotate(180deg);
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .collapsible.active .collapsible-content {
            max-height: 500px;
        }

        .collapsible-inner {
            padding: 20px;
            border-top: 1px solid #333333;
        }

        .collapsible-inner ul {
            list-style-position: inside;
            color: #cccccc;
            font-size: 14px;
            line-height: 1.8;
        }

        /* ä¸Šä¼ åŒºåŸŸ */
        .upload-section {
            background-color: #1a1a1a;
            border: 1px solid #333333;
            padding: 30px;
            margin-bottom: 30px;
        }

        .upload-section h2 {
            font-size: 20px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .upload-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }

        .file-upload-box {
            border: 2px dashed #555555;
            padding: 20px;
            text-align: center;
            background-color: #000000;
            transition: all 0.2s;
            position: relative;
        }

        .file-upload-box:hover {
            border-color: #ffffff;
        }

        .file-upload-box.dragover {
            border-color: #ffffff;
            background-color: #1a1a1a;
        }

        .file-upload-box label {
            display: block;
            margin-bottom: 15px;
            font-size: 16px;
            font-weight: 500;
        }

        .file-upload-box input[type="file"] {
            display: none;
        }

        .upload-btn {
            display: inline-block;
            padding: 10px 20px;
            background-color: #ffffff;
            color: #000000;
            cursor: pointer;
            border: 1px solid #ffffff;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .upload-btn:hover {
            background-color: #cccccc;
        }

        .file-count {
            font-size: 12px;
            color: #888888;
        }

        .drag-hint {
            font-size: 12px;
            color: #666666;
            margin-top: 8px;
        }

        /* æ–‡ä»¶åˆ—è¡¨ */
        .file-list-section {
            background-color: #1a1a1a;
            border: 1px solid #333333;
            padding: 30px;
            margin-bottom: 30px;
            display: none;
        }

        .file-list-section.active {
            display: block;
        }

        .file-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .file-list-header h2 {
            font-size: 20px;
            font-weight: 500;
        }

        .sort-btn {
            padding: 8px 16px;
            background-color: #000000;
            color: #ffffff;
            border: 1px solid #555555;
            cursor: pointer;
            font-size: 13px;
        }

        .sort-btn:hover {
            border-color: #ffffff;
        }

        .file-lists {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .file-list {
            background-color: #000000;
            border: 1px solid #333333;
        }

        .file-list-title {
            padding: 10px;
            background-color: #1a1a1a;
            border-bottom: 1px solid #333333;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-list-title-left {
            display: flex;
            align-items: baseline;
            gap: 8px;
        }

        .file-count-text {
            font-size: 12px;
            color: #888888;
            font-weight: normal;
        }

        .file-list-items {
            max-height: 300px;
            overflow-y: auto;
            min-height: 60px;
        }

        .file-list-items:empty::after {
            content: 'æš‚æ— æ–‡ä»¶';
            display: block;
            text-align: center;
            color: #666666;
            padding: 20px;
            font-size: 13px;
        }

        .file-item {
            padding: 12px;
            border-bottom: 1px solid #222222;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
        }

        .file-item:last-child {
            border-bottom: none;
        }

        .file-item:hover {
            background-color: #1a1a1a;
        }

        .file-name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .file-remove {
            margin-left: 10px;
            color: #ff6666;
            cursor: pointer;
            font-size: 16px;
        }

        .file-remove:hover {
            color: #ff0000;
        }

        .clear-all-btn {
            padding: 10px 20px;
            background-color: #000000;
            color: #ffffff;
            border: 1px solid #555555;
            cursor: pointer;
            font-size: 14px;
        }

        .clear-all-btn:hover {
            border-color: #ff0000;
            color: #ff6666;
        }

        /* é€‰é¡¹å’ŒæŒ‰é’® */
        .options-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .option-item label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            color: #cccccc;
        }

        select {
            width: 100%;
            padding: 10px;
            background-color: #000000;
            border: 1px solid #555555;
            color: #ffffff;
            cursor: pointer;
        }

        select:hover {
            border-color: #ffffff;
        }

        select option {
            background-color: #000000;
            color: #ffffff;
        }

        /* é¢œè‰²é€‰æ‹©å™¨æ ·å¼ */
        input[type="color"] {
            width: 100%;
            height: 40px;
            padding: 5px;
            border: 1px solid #555555;
            background-color: #000000;
            cursor: pointer;
        }

        input[type="color"]:hover {
            border-color: #ffffff;
        }

        /* æ ·å¼å¤é€‰æ¡† */
        .style-checkboxes {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .style-checkboxes label {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 13px;
            color: #cccccc;
            cursor: pointer;
        }

        .style-checkboxes input[type="checkbox"] {
            cursor: pointer;
        }

        .btn {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            border: 2px solid #ffffff;
            background-color: #000000;
            color: #ffffff;
            transition: all 0.2s;
        }

        .btn:hover:not(:disabled) {
            background-color: #ffffff;
            color: #000000;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            border-color: #555555;
            color: #555555;
        }

        /* è¿›åº¦åŒºåŸŸ */
        .progress-section {
            display: none;
            background-color: #1a1a1a;
            border: 1px solid #333333;
            padding: 30px;
            margin-bottom: 30px;
        }

        .progress-section.active {
            display: block;
        }

        .progress-section h2 {
            font-size: 20px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .overall-progress {
            margin-bottom: 25px;
        }

        .overall-progress-label {
            font-size: 14px;
            color: #cccccc;
            margin-bottom: 8px;
        }

        .progress-bar-container {
            width: 100%;
            height: 30px;
            background-color: #000000;
            border: 1px solid #555555;
            position: relative;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background-color: #ffffff;
            width: 0%;
            transition: width 0.3s;
        }

        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 14px;
            font-weight: 600;
            color: #000000;
            mix-blend-mode: difference;
        }

        .task-progress-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .task-item {
            padding: 12px;
            background-color: #000000;
            border: 1px solid #333333;
            margin-bottom: 10px;
            font-size: 13px;
        }

        .task-item-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .task-status {
            font-size: 12px;
        }

        .task-status.processing {
            color: #ffff00;
        }

        .task-status.completed {
            color: #00ff00;
        }

        .task-status.error {
            color: #ff0000;
        }

        .task-progress-bar {
            height: 4px;
            background-color: #333333;
            overflow: hidden;
        }

        .task-progress-fill {
            height: 100%;
            background-color: #ffffff;
            width: 0%;
            transition: width 0.3s;
        }

        /* ç»“æœåŒºåŸŸ */
        .result-section {
            display: none;
            background-color: #1a1a1a;
            border: 1px solid #333333;
            padding: 30px;
            margin-bottom: 30px;
        }

        .result-section.active {
            display: block;
        }

        .result-section h2 {
            font-size: 20px;
            margin-bottom: 20px;
            color: #00ff00;
        }

        .result-summary {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #000000;
            border: 1px solid #333333;
            font-size: 14px;
            color: #cccccc;
        }

        .download-all-btn {
            padding: 12px 24px;
            background-color: #ffffff;
            color: #000000;
            border: 2px solid #ffffff;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            margin-right: 10px;
        }

        .download-all-btn:hover {
            background-color: #000000;
            color: #ffffff;
        }

        .result-file-list {
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }

        .result-file-item {
            padding: 10px;
            background-color: #000000;
            border: 1px solid #333333;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
        }

        .download-link {
            color: #ffffff;
            text-decoration: none;
            padding: 6px 12px;
            border: 1px solid #555555;
            font-size: 12px;
        }

        .download-link:hover {
            border-color: #ffffff;
            background-color: #1a1a1a;
        }

        .reset-btn {
            margin-top: 15px;
            padding: 10px 20px;
            background-color: #000000;
            color: #ffffff;
            border: 1px solid #555555;
            cursor: pointer;
            font-size: 14px;
        }

        .reset-btn:hover {
            border-color: #ffffff;
            background-color: #1a1a1a;
        }

        .error-section {
            display: none;
            background-color: #1a1a1a;
            border: 1px solid #ff0000;
            padding: 30px;
            margin-bottom: 30px;
        }

        .error-section.active {
            display: block;
        }

        .error-section h2 {
            font-size: 20px;
            margin-bottom: 15px;
            color: #ff0000;
        }

        .error-text {
            color: #ff6666;
            font-size: 14px;
            font-family: monospace;
        }

        @media (max-width: 768px) {
            .upload-grid,
            .file-lists,
            .options-group {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>TXTSubAlign - éŸ³é¢‘æ–‡æœ¬å¯¹é½å·¥å…·</h1>

        <!-- ä½¿ç”¨è¯´æ˜ï¼ˆå¯æŠ˜å ï¼‰ -->
        <div class="collapsible">
            <div class="collapsible-header" onclick="toggleCollapsible(this)">
                <h3>ğŸ“– ä½¿ç”¨è¯´æ˜</h3>
                <span class="collapsible-icon">â–¼</span>
            </div>
            <div class="collapsible-content">
                <div class="collapsible-inner">
                    <ul>
                        <li>æ”¯æŒæ··åˆä¸Šä¼ éŸ³é¢‘å’Œæ–‡æœ¬æ–‡ä»¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è¯†åˆ«å¹¶åˆ†ç±»åˆ°å¯¹åº”åˆ—è¡¨</li>
                        <li>æ”¯æŒç‚¹å‡»ä¸Šä¼ æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°ä¸Šä¼ æ¡†ï¼Œå¯ä»¥å¤šæ¬¡æ·»åŠ æ–‡ä»¶</li>
                        <li>é‡å¤æ–‡ä»¶ä¼šè‡ªåŠ¨è¿‡æ»¤ï¼Œåªæ·»åŠ æ–°æ–‡ä»¶</li>
                        <li>ä¸Šä¼ åä¼šè‡ªåŠ¨æŒ‰æ–‡ä»¶åæ’åº</li>
                        <li>å·¦ä¾§éŸ³é¢‘åˆ—è¡¨ä¸å³ä¾§æ–‡æœ¬åˆ—è¡¨æŒ‰è¡Œå¯¹åº”ï¼ˆç¬¬1ä¸ªéŸ³é¢‘å¯¹åº”ç¬¬1ä¸ªæ–‡æœ¬ï¼‰</li>
                        <li>å¯ä»¥å•ç‹¬å¯¹éŸ³é¢‘æˆ–æ–‡æœ¬åˆ—è¡¨è¿›è¡Œæ’åº</li>
                        <li>ç¡®ä¿ä¸¤ä¾§æ–‡ä»¶æ•°é‡ä¸€è‡´ï¼Œå¦åˆ™æ— æ³•å¼€å§‹å¤„ç†</li>
                        <li>å¤„ç†å®Œæˆåå¯å•ç‹¬ä¸‹è½½æˆ–æ‰¹é‡ä¸‹è½½æ‰€æœ‰å­—å¹•æ–‡ä»¶</li>
                        <li>å†å²è®°å½•ä¼šè‡ªåŠ¨ä¿å­˜ï¼Œåˆ·æ–°é¡µé¢åå¯ç»§ç»­ä¸‹è½½</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- æ–‡ä»¶ç®¡ç†åŒºåŸŸ -->
        <div class="upload-section">
            <h2>æ–‡ä»¶ç®¡ç†</h2>

            <!-- ç»Ÿä¸€ä¸Šä¼ åŒºåŸŸ -->
            <div style="margin-bottom: 20px;">
                <div class="file-upload-box" id="mixedUploadBox">
                    <label>æ··åˆä¸Šä¼ éŸ³é¢‘å’Œæ–‡æœ¬æ–‡ä»¶</label>
                    <label for="mixedFiles" class="upload-btn">+ æ·»åŠ æ–‡ä»¶ (æ”¯æŒ MP3/WAV/M4A/TXT)</label>
                    <input type="file" id="mixedFiles" accept=".mp3,.wav,.m4a,.txt" multiple onchange="handleMixedUpload(this)">
                    <div class="drag-hint">æˆ–æ‹–æ‹½éŸ³é¢‘å’Œæ–‡æœ¬æ–‡ä»¶åˆ°æ­¤åŒºåŸŸï¼Œè‡ªåŠ¨è¯†åˆ«åˆ†ç±»</div>
                </div>
            </div>

            <!-- æ–‡ä»¶åˆ—è¡¨æ˜¾ç¤ºåŒºåŸŸ -->
            <div class="upload-grid">
                <!-- éŸ³é¢‘æ–‡ä»¶åˆ—è¡¨ -->
                <div>
                    <div class="file-list">
                        <div class="file-list-title">
                            <div class="file-list-title-left">
                                <span>éŸ³é¢‘</span>
                                <span class="file-count-text"><span id="audioListCount">0</span> ä¸ªæ–‡ä»¶</span>
                            </div>
                            <button class="sort-btn" onclick="sortAudioFiles()" style="padding: 4px 8px; font-size: 12px;">æ’åº</button>
                        </div>
                        <div class="file-list-items" id="audioList"></div>
                    </div>
                </div>

                <!-- æ–‡æœ¬æ–‡ä»¶åˆ—è¡¨ -->
                <div>
                    <div class="file-list">
                        <div class="file-list-title">
                            <div class="file-list-title-left">
                                <span>æ–‡æœ¬</span>
                                <span class="file-count-text"><span id="textListCount">0</span> ä¸ªæ–‡ä»¶</span>
                            </div>
                            <button class="sort-btn" onclick="sortTextFiles()" style="padding: 4px 8px; font-size: 12px;">æ’åº</button>
                        </div>
                        <div class="file-list-items" id="textList"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ“ä½œåŒºåŸŸ -->
        <div class="file-list-section" id="fileListSection">
            <div class="file-list-header">
                <h2>æ‰¹é‡æ“ä½œ</h2>
                <div>
                    <button class="clear-all-btn" onclick="clearAllFiles()">ğŸ—‘ æ¸…ç©ºæ‰€æœ‰æ–‡ä»¶</button>
                </div>
            </div>

            <div class="options-group">
                <div class="option-item">
                    <label for="language">è¯­è¨€</label>
                    <select id="language">
                        <option value="zh">ä¸­æ–‡</option>
                        <option value="en">è‹±æ–‡</option>
                        <option value="ja">æ—¥æ–‡</option>
                        <option value="ko">éŸ©æ–‡</option>
                        <option value="es">è¥¿ç­ç‰™æ–‡</option>
                        <option value="fr">æ³•æ–‡</option>
                    </select>
                </div>

                <div class="option-item">
                    <label for="modelSize">æ¨¡å‹å¤§å°</label>
                    <select id="modelSize">
                        <option value="tiny">Tiny (æœ€å¿«)</option>
                        <option value="base" selected>Base (æ¨è)</option>
                        <option value="small">Small</option>
                        <option value="medium">Medium</option>
                        <option value="large">Large (æœ€å‡†ç¡®)</option>
                    </select>
                </div>

                <div class="option-item">
                    <label for="outputFormat">è¾“å‡ºæ ¼å¼</label>
                    <select id="outputFormat">
                        <option value="srt" selected>SRT</option>
                        <option value="ass">ASS</option>
                        <option value="json">JSON</option>
                        <option value="tsv">TSV</option>
                    </select>
                </div>

                <div class="option-item">
                    <label for="subtitleMode">å­—å¹•æ ¼å¼</label>
                    <select id="subtitleMode">
                        <option value="segment" selected>å¥å­çº§ (æ¨è)</option>
                        <option value="word">å•è¯çº§é«˜äº®</option>
                    </select>
                </div>
            </div>

            <!-- é«˜äº®æ ·å¼è®¾ç½®åŒºï¼ˆä»…åœ¨é€‰æ‹©"å•è¯çº§é«˜äº®"æ—¶æ˜¾ç¤ºï¼‰ -->
            <div class="options-group" id="highlightSettings" style="display: none;">
                <div class="option-item">
                    <label for="highlightColor">é«˜äº®é¢œè‰²</label>
                    <input type="color" id="highlightColor" value="#00ff00">
                </div>

                <div class="option-item">
                    <label>æ–‡æœ¬æ ·å¼</label>
                    <div class="style-checkboxes">
                        <label><input type="checkbox" id="styleBold"> ç²—ä½“</label>
                        <label><input type="checkbox" id="styleItalic"> æ–œä½“</label>
                        <label><input type="checkbox" id="styleUnderline"> ä¸‹åˆ’çº¿</label>
                    </div>
                </div>
            </div>

            <button class="btn" id="batchAlignBtn" onclick="startBatchAlignment()">å¼€å§‹æ‰¹é‡å¯¹é½</button>
        </div>

        <!-- è¿›åº¦åŒºåŸŸ -->
        <div class="progress-section" id="progressSection">
            <h2>å¤„ç†è¿›åº¦</h2>

            <div class="overall-progress">
                <div class="overall-progress-label">æ€»ä½“è¿›åº¦: <span id="overallProgressText">0/0</span></div>
                <div class="progress-bar-container">
                    <div class="progress-bar" id="overallProgressBar"></div>
                    <div class="progress-text" id="overallProgressPercent">0%</div>
                </div>
            </div>

            <div class="task-progress-list" id="taskProgressList"></div>
        </div>

        <!-- é”™è¯¯åŒºåŸŸ -->
        <div class="error-section" id="errorSection">
            <h2>å¤„ç†å¤±è´¥</h2>
            <div class="error-text" id="errorText"></div>
            <button class="reset-btn" onclick="resetAll()">é‡æ–°å¼€å§‹</button>
        </div>

        <!-- ç»“æœåŒºåŸŸ -->
        <div class="result-section" id="resultSection">
            <h2>âœ“ æ‰¹é‡å¤„ç†å®Œæˆ</h2>

            <div class="result-summary" id="resultSummary"></div>

            <div>
                <button class="download-all-btn" onclick="downloadAllFiles()">ğŸ“¥ ä¸‹è½½æ‰€æœ‰å­—å¹•</button>
                <button class="reset-btn" onclick="resetAll()">å¤„ç†æ–°æ–‡ä»¶</button>
                <button class="clear-all-btn" onclick="clearHistory()" style="margin-left: 10px;">ğŸ—‘ æ¸…ç©ºå†å²</button>
            </div>

            <div class="result-file-list" id="resultFileList"></div>
        </div>
    </div>

    <script>
        let audioFiles = [];
        let textFiles = [];
        let processingTasks = [];
        let completedFiles = [];

        // åˆå§‹åŒ–æ‹–æ‹½åŠŸèƒ½å’Œæ¢å¤å†å²è®°å½•
        document.addEventListener('DOMContentLoaded', function() {
            initDragAndDrop();
            restoreFromHistory();
            restoreSubtitlePreferences();
            initSubtitleModeListeners();
        });

        // åˆå§‹åŒ–æ‹–æ‹½å’Œæ”¾ç½®
        function initDragAndDrop() {
            const mixedBox = document.getElementById('mixedUploadBox');

            // æ··åˆæ–‡ä»¶æ‹–æ‹½ï¼ˆæ”¯æŒéŸ³é¢‘å’Œæ–‡æœ¬ï¼‰
            setupDragDrop(mixedBox, handleMixedDrop, ['.mp3', '.wav', '.m4a', '.txt']);
        }

        // è®¾ç½®æ‹–æ‹½åŠŸèƒ½
        function setupDragDrop(element, dropHandler, allowedExtensions) {
            // é˜»æ­¢é»˜è®¤è¡Œä¸º
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                element.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            // æ‹–æ‹½è¿›å…¥å’Œç¦»å¼€æ—¶çš„è§†è§‰åé¦ˆ
            ['dragenter', 'dragover'].forEach(eventName => {
                element.addEventListener(eventName, () => {
                    element.classList.add('dragover');
                }, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                element.addEventListener(eventName, () => {
                    element.classList.remove('dragover');
                }, false);
            });

            // å¤„ç†æ–‡ä»¶æ”¾ç½®
            element.addEventListener('drop', (e) => {
                const dt = e.dataTransfer;
                const files = Array.from(dt.files);

                // è¿‡æ»¤æ–‡ä»¶ç±»å‹
                const validFiles = files.filter(file => {
                    const ext = '.' + file.name.split('.').pop().toLowerCase();
                    return allowedExtensions.includes(ext);
                });

                if (validFiles.length > 0) {
                    dropHandler(validFiles);
                } else {
                    alert(`è¯·æ‹–æ‹½æ­£ç¡®çš„æ–‡ä»¶ç±»å‹ï¼š${allowedExtensions.join(', ')}`);
                }
            }, false);
        }

        // å¤„ç†æ··åˆæ–‡ä»¶æ‹–æ‹½æ”¾ç½®ï¼ˆå¢é‡æ·»åŠ ï¼Œè‡ªåŠ¨è¯†åˆ«ï¼‰
        function handleMixedDrop(files) {
            // å®šä¹‰éŸ³é¢‘å’Œæ–‡æœ¬æ–‡ä»¶æ‰©å±•å
            const audioExtensions = ['.mp3', '.wav', '.m4a'];
            const textExtensions = ['.txt'];

            // åˆ†ç¦»éŸ³é¢‘å’Œæ–‡æœ¬æ–‡ä»¶
            const newAudioFiles = [];
            const newTextFiles = [];

            files.forEach(file => {
                const ext = '.' + file.name.split('.').pop().toLowerCase();
                if (audioExtensions.includes(ext)) {
                    newAudioFiles.push(file);
                } else if (textExtensions.includes(ext)) {
                    newTextFiles.push(file);
                }
            });

            // è¿‡æ»¤æ‰å·²å­˜åœ¨çš„æ–‡ä»¶
            const existingAudioNames = new Set(audioFiles.map(f => f.name));
            const existingTextNames = new Set(textFiles.map(f => f.name));

            const uniqueAudioFiles = newAudioFiles.filter(f => !existingAudioNames.has(f.name));
            const uniqueTextFiles = newTextFiles.filter(f => !existingTextNames.has(f.name));

            // å¢é‡æ·»åŠ 
            audioFiles = [...audioFiles, ...uniqueAudioFiles];
            textFiles = [...textFiles, ...uniqueTextFiles];

            // è‡ªåŠ¨æ’åº
            audioFiles.sort((a, b) => a.name.localeCompare(b.name));
            textFiles.sort((a, b) => a.name.localeCompare(b.name));

            const totalNew = uniqueAudioFiles.length + uniqueTextFiles.length;
            if (totalNew > 0) {
                updateFileLists();
            } else {
                alert('æ‰€æœ‰æ–‡ä»¶å·²å­˜åœ¨äºåˆ—è¡¨ä¸­');
            }
        }

        // æŠ˜å é¢æ¿åˆ‡æ¢
        function toggleCollapsible(header) {
            const collapsible = header.parentElement;
            collapsible.classList.toggle('active');
        }

        // å¤„ç†æ··åˆæ–‡ä»¶ä¸Šä¼ ï¼ˆå¢é‡æ·»åŠ ï¼Œè‡ªåŠ¨è¯†åˆ«ï¼‰
        function handleMixedUpload(input) {
            const files = Array.from(input.files);

            // å®šä¹‰éŸ³é¢‘å’Œæ–‡æœ¬æ–‡ä»¶æ‰©å±•å
            const audioExtensions = ['.mp3', '.wav', '.m4a'];
            const textExtensions = ['.txt'];

            // åˆ†ç¦»éŸ³é¢‘å’Œæ–‡æœ¬æ–‡ä»¶
            const newAudioFiles = [];
            const newTextFiles = [];

            files.forEach(file => {
                const ext = '.' + file.name.split('.').pop().toLowerCase();
                if (audioExtensions.includes(ext)) {
                    newAudioFiles.push(file);
                } else if (textExtensions.includes(ext)) {
                    newTextFiles.push(file);
                }
            });

            // è¿‡æ»¤æ‰å·²å­˜åœ¨çš„æ–‡ä»¶
            const existingAudioNames = new Set(audioFiles.map(f => f.name));
            const existingTextNames = new Set(textFiles.map(f => f.name));

            const uniqueAudioFiles = newAudioFiles.filter(f => !existingAudioNames.has(f.name));
            const uniqueTextFiles = newTextFiles.filter(f => !existingTextNames.has(f.name));

            // å¢é‡æ·»åŠ 
            audioFiles = [...audioFiles, ...uniqueAudioFiles];
            textFiles = [...textFiles, ...uniqueTextFiles];

            // è‡ªåŠ¨æ’åº
            audioFiles.sort((a, b) => a.name.localeCompare(b.name));
            textFiles.sort((a, b) => a.name.localeCompare(b.name));

            // æ¸…ç©ºinputï¼Œå…è®¸å†æ¬¡é€‰æ‹©ç›¸åŒæ–‡ä»¶
            input.value = '';

            const totalNew = uniqueAudioFiles.length + uniqueTextFiles.length;
            if (totalNew > 0) {
                updateFileLists();
            } else {
                alert('æ‰€æœ‰æ–‡ä»¶å·²å­˜åœ¨äºåˆ—è¡¨ä¸­');
            }
        }

        // æ›´æ–°æ–‡ä»¶åˆ—è¡¨æ˜¾ç¤º
        function updateFileLists() {
            const audioList = document.getElementById('audioList');
            const textList = document.getElementById('textList');

            // æ¸…ç©ºåˆ—è¡¨
            audioList.innerHTML = '';
            textList.innerHTML = '';

            // æ˜¾ç¤ºéŸ³é¢‘æ–‡ä»¶
            audioFiles.forEach((file, index) => {
                const item = document.createElement('div');
                item.className = 'file-item';
                item.innerHTML = `
                    <span class="file-name" title="${file.name}">${index + 1}. ${file.name}</span>
                    <span class="file-remove" onclick="removeAudioFile(${index})">âœ•</span>
                `;
                audioList.appendChild(item);
            });

            // æ˜¾ç¤ºæ–‡æœ¬æ–‡ä»¶
            textFiles.forEach((file, index) => {
                const item = document.createElement('div');
                item.className = 'file-item';
                item.innerHTML = `
                    <span class="file-name" title="${file.name}">${index + 1}. ${file.name}</span>
                    <span class="file-remove" onclick="removeTextFile(${index})">âœ•</span>
                `;
                textList.appendChild(item);
            });

            // æ›´æ–°è®¡æ•°
            document.getElementById('audioListCount').textContent = audioFiles.length;
            document.getElementById('textListCount').textContent = textFiles.length;

            // æ˜¾ç¤ºæ–‡ä»¶åˆ—è¡¨åŒºåŸŸ
            if (audioFiles.length > 0 || textFiles.length > 0) {
                document.getElementById('fileListSection').classList.add('active');
            } else {
                document.getElementById('fileListSection').classList.remove('active');
            }
        }

        // åˆ é™¤éŸ³é¢‘æ–‡ä»¶
        function removeAudioFile(index) {
            audioFiles.splice(index, 1);
            updateFileLists();
        }

        // åˆ é™¤æ–‡æœ¬æ–‡ä»¶
        function removeTextFile(index) {
            textFiles.splice(index, 1);
            updateFileLists();
        }

        // éŸ³é¢‘æ–‡ä»¶åæ’åº
        function sortAudioFiles() {
            audioFiles.sort((a, b) => a.name.localeCompare(b.name));
            updateFileLists();
        }

        // æ–‡æœ¬æ–‡ä»¶åæ’åº
        function sortTextFiles() {
            textFiles.sort((a, b) => a.name.localeCompare(b.name));
            updateFileLists();
        }

        // æ¸…ç©ºæ‰€æœ‰æ–‡ä»¶
        function clearAllFiles() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ–‡ä»¶å—ï¼Ÿ')) {
                audioFiles = [];
                textFiles = [];
                document.getElementById('mixedFiles').value = '';
                updateFileLists();
            }
        }

        // å¼€å§‹æ‰¹é‡å¯¹é½
        async function startBatchAlignment() {
            // éªŒè¯æ–‡ä»¶æ•°é‡
            if (audioFiles.length === 0 || textFiles.length === 0) {
                alert('è¯·å…ˆä¸Šä¼ éŸ³é¢‘å’Œæ–‡æœ¬æ–‡ä»¶');
                return;
            }

            if (audioFiles.length !== textFiles.length) {
                alert(`æ–‡ä»¶æ•°é‡ä¸åŒ¹é…ï¼\néŸ³é¢‘æ–‡ä»¶: ${audioFiles.length} ä¸ª\næ–‡æœ¬æ–‡ä»¶: ${textFiles.length} ä¸ª\n\nè¯·ç¡®ä¿ä¸¤ä¾§æ–‡ä»¶æ•°é‡ä¸€è‡´`);
                return;
            }

            // è·å–é€‰é¡¹
            const language = document.getElementById('language').value;
            const modelSize = document.getElementById('modelSize').value;
            const outputFormat = document.getElementById('outputFormat').value;

            // è·å–å­—å¹•æ ¼å¼è®¾ç½®
            const subtitleMode = document.getElementById('subtitleMode').value;
            const highlightColor = document.getElementById('highlightColor').value;
            const styleBold = document.getElementById('styleBold').checked;
            const styleItalic = document.getElementById('styleItalic').checked;
            const styleUnderline = document.getElementById('styleUnderline').checked;

            // ç”Ÿæˆæ‰¹æ¬¡IDï¼ˆä½¿ç”¨æ—¶é—´æˆ³ï¼‰
            const batchId = new Date().toISOString().replace(/:/g, '-').replace(/\..+/, '').replace('T', '_');

            // ç¦ç”¨æŒ‰é’®
            document.getElementById('batchAlignBtn').disabled = true;

            // æ˜¾ç¤ºè¿›åº¦åŒºåŸŸ
            document.getElementById('progressSection').classList.add('active');
            document.getElementById('errorSection').classList.remove('active');
            document.getElementById('resultSection').classList.remove('active');

            // åˆå§‹åŒ–ä»»åŠ¡åˆ—è¡¨
            processingTasks = [];
            completedFiles = [];

            const taskProgressList = document.getElementById('taskProgressList');
            taskProgressList.innerHTML = '';

            // åˆ›å»ºä»»åŠ¡é¡¹
            for (let i = 0; i < audioFiles.length; i++) {
                const taskItem = document.createElement('div');
                taskItem.className = 'task-item';
                taskItem.id = `task-${i}`;
                taskItem.innerHTML = `
                    <div class="task-item-header">
                        <span class="task-name">${i + 1}. ${audioFiles[i].name}</span>
                        <span class="task-status processing" id="task-status-${i}">ç­‰å¾…ä¸­...</span>
                    </div>
                    <div class="task-progress-bar">
                        <div class="task-progress-fill" id="task-progress-${i}"></div>
                    </div>
                `;
                taskProgressList.appendChild(taskItem);

                processingTasks.push({
                    index: i,
                    audioFile: audioFiles[i],
                    textFile: textFiles[i],
                    status: 'pending'
                });
            }

            // ä¾æ¬¡å¤„ç†æ¯ä¸ªä»»åŠ¡
            for (let i = 0; i < processingTasks.length; i++) {
                await processTask(i, language, modelSize, outputFormat, batchId, subtitleMode, highlightColor, styleBold, styleItalic, styleUnderline);
                updateOverallProgress();
            }

            // å…¨éƒ¨å®Œæˆ
            showResults();
        }

        // å¤„ç†å•ä¸ªä»»åŠ¡
        async function processTask(index, language, modelSize, outputFormat, batchId, subtitleMode, highlightColor, styleBold, styleItalic, styleUnderline) {
            const task = processingTasks[index];

            // æ›´æ–°çŠ¶æ€
            document.getElementById(`task-status-${index}`).textContent = 'å¤„ç†ä¸­...';
            document.getElementById(`task-progress-${index}`).style.width = '10%';

            try {
                // å‡†å¤‡è¡¨å•æ•°æ®
                const formData = new FormData();
                formData.append('audio', task.audioFile);
                formData.append('text', task.textFile);
                formData.append('language', language);
                formData.append('model_size', modelSize);
                formData.append('output_format', outputFormat);
                formData.append('batch_id', batchId);

                // æ·»åŠ å­—å¹•æ ¼å¼å‚æ•°
                formData.append('subtitle_mode', subtitleMode);
                if (subtitleMode === 'word') {
                    formData.append('highlight_color', highlightColor);
                    formData.append('style_bold', styleBold);
                    formData.append('style_italic', styleItalic);
                    formData.append('style_underline', styleUnderline);
                }

                // å‘é€è¯·æ±‚
                const response = await fetch('/api/align', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    // è½®è¯¢çŠ¶æ€
                    await pollTaskStatus(index, data.task_id, outputFormat);
                } else {
                    throw new Error(data.error || 'å¤„ç†å¤±è´¥');
                }
            } catch (error) {
                task.status = 'error';
                task.error = error.message;
                document.getElementById(`task-status-${index}`).textContent = 'å¤±è´¥';
                document.getElementById(`task-status-${index}`).className = 'task-status error';
                document.getElementById(`task-progress-${index}`).style.width = '0%';
                document.getElementById(`task-progress-${index}`).style.backgroundColor = '#ff0000';
            }
        }

        // è½®è¯¢ä»»åŠ¡çŠ¶æ€
        async function pollTaskStatus(index, taskId, outputFormat) {
            return new Promise((resolve) => {
                const checkStatus = async () => {
                    try {
                        const response = await fetch(`/api/status/${taskId}`);
                        const data = await response.json();

                        if (data.status === 'processing') {
                            const progress = data.progress || 0;
                            document.getElementById(`task-progress-${index}`).style.width = progress + '%';
                            setTimeout(checkStatus, 500);
                        } else if (data.status === 'completed') {
                            processingTasks[index].status = 'completed';
                            processingTasks[index].outputFile = data.output_file;
                            document.getElementById(`task-status-${index}`).textContent = 'å®Œæˆ';
                            document.getElementById(`task-status-${index}`).className = 'task-status completed';
                            document.getElementById(`task-progress-${index}`).style.width = '100%';

                            completedFiles.push({
                                name: processingTasks[index].audioFile.name,
                                outputFile: data.output_file,
                                format: outputFormat
                            });

                            resolve();
                        } else if (data.status === 'error') {
                            processingTasks[index].status = 'error';
                            processingTasks[index].error = data.error;
                            document.getElementById(`task-status-${index}`).textContent = 'å¤±è´¥';
                            document.getElementById(`task-status-${index}`).className = 'task-status error';
                            document.getElementById(`task-progress-${index}`).style.width = '0%';
                            document.getElementById(`task-progress-${index}`).style.backgroundColor = '#ff0000';
                            resolve();
                        }
                    } catch (error) {
                        processingTasks[index].status = 'error';
                        processingTasks[index].error = error.message;
                        document.getElementById(`task-status-${index}`).textContent = 'å¤±è´¥';
                        document.getElementById(`task-status-${index}`).className = 'task-status error';
                        resolve();
                    }
                };
                checkStatus();
            });
        }

        // æ›´æ–°æ€»ä½“è¿›åº¦
        function updateOverallProgress() {
            const total = processingTasks.length;
            const completed = processingTasks.filter(t => t.status === 'completed' || t.status === 'error').length;
            const percentage = Math.round((completed / total) * 100);

            document.getElementById('overallProgressText').textContent = `${completed}/${total}`;
            document.getElementById('overallProgressBar').style.width = percentage + '%';
            document.getElementById('overallProgressPercent').textContent = percentage + '%';
        }

        // æ˜¾ç¤ºç»“æœ
        function showResults() {
            document.getElementById('progressSection').classList.remove('active');
            document.getElementById('resultSection').classList.add('active');

            const successCount = processingTasks.filter(t => t.status === 'completed').length;
            const failCount = processingTasks.filter(t => t.status === 'error').length;

            document.getElementById('resultSummary').innerHTML = `
                æ€»è®¡: ${processingTasks.length} ä¸ªæ–‡ä»¶<br>
                æˆåŠŸ: ${successCount} ä¸ª<br>
                å¤±è´¥: ${failCount} ä¸ª
            `;

            // æ˜¾ç¤ºæ–‡ä»¶åˆ—è¡¨
            const resultFileList = document.getElementById('resultFileList');
            resultFileList.innerHTML = '';

            completedFiles.forEach((file, index) => {
                const item = document.createElement('div');
                item.className = 'result-file-item';
                item.innerHTML = `
                    <span class="file-name">${index + 1}. ${file.outputFile}</span>
                    <a href="/api/download/${file.outputFile}" class="download-link" download>ä¸‹è½½</a>
                `;
                resultFileList.appendChild(item);
            });

            // ä¿å­˜åˆ°å†å²è®°å½•
            saveToHistory();
        }

        // ä¸‹è½½æ‰€æœ‰æ–‡ä»¶
        function downloadAllFiles() {
            completedFiles.forEach((file, index) => {
                setTimeout(() => {
                    const link = document.createElement('a');
                    link.href = `/api/download/${file.outputFile}`;
                    link.download = file.outputFile;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }, index * 200);
            });
        }

        // é‡ç½®æ‰€æœ‰ï¼ˆä¸æ¸…ç©ºå†å²è®°å½•ï¼‰
        function resetAll() {
            audioFiles = [];
            textFiles = [];
            processingTasks = [];

            document.getElementById('mixedFiles').value = '';

            document.getElementById('fileListSection').classList.remove('active');
            document.getElementById('progressSection').classList.remove('active');
            document.getElementById('errorSection').classList.remove('active');
            document.getElementById('resultSection').classList.remove('active');

            document.getElementById('batchAlignBtn').disabled = false;

            updateFileLists();
        }

        // ä¿å­˜åˆ°å†å²è®°å½•
        function saveToHistory() {
            try {
                const historyData = {
                    completedFiles: completedFiles,
                    timestamp: new Date().toISOString(),
                    summary: {
                        total: processingTasks.length,
                        success: processingTasks.filter(t => t.status === 'completed').length,
                        fail: processingTasks.filter(t => t.status === 'error').length
                    }
                };
                localStorage.setItem('stableTsHistory', JSON.stringify(historyData));
            } catch (e) {
                console.error('ä¿å­˜å†å²è®°å½•å¤±è´¥:', e);
            }
        }

        // ä»å†å²è®°å½•æ¢å¤
        function restoreFromHistory() {
            try {
                const historyData = localStorage.getItem('stableTsHistory');
                if (historyData) {
                    const data = JSON.parse(historyData);
                    completedFiles = data.completedFiles || [];

                    if (completedFiles.length > 0) {
                        // æ˜¾ç¤ºç»“æœåŒºåŸŸ
                        document.getElementById('resultSection').classList.add('active');

                        // æ˜¾ç¤ºæ‘˜è¦
                        const summary = data.summary || {};
                        document.getElementById('resultSummary').innerHTML = `
                            æ€»è®¡: ${summary.total || completedFiles.length} ä¸ªæ–‡ä»¶<br>
                            æˆåŠŸ: ${summary.success || completedFiles.length} ä¸ª<br>
                            å¤±è´¥: ${summary.fail || 0} ä¸ª
                        `;

                        // æ˜¾ç¤ºæ–‡ä»¶åˆ—è¡¨
                        const resultFileList = document.getElementById('resultFileList');
                        resultFileList.innerHTML = '';

                        completedFiles.forEach((file, index) => {
                            const item = document.createElement('div');
                            item.className = 'result-file-item';
                            item.innerHTML = `
                                <span class="file-name">${index + 1}. ${file.outputFile}</span>
                                <a href="/api/download/${file.outputFile}" class="download-link" download>ä¸‹è½½</a>
                            `;
                            resultFileList.appendChild(item);
                        });
                    }
                }
            } catch (e) {
                console.error('æ¢å¤å†å²è®°å½•å¤±è´¥:', e);
            }
        }

        // æ¸…ç©ºå†å²è®°å½•
        function clearHistory() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•å—ï¼Ÿè¿™å°†åˆ é™¤æ‰€æœ‰å·²å®Œæˆä»»åŠ¡çš„è®°å½•ã€‚')) {
                try {
                    localStorage.removeItem('stableTsHistory');
                    completedFiles = [];
                    document.getElementById('resultSection').classList.remove('active');
                    alert('å†å²è®°å½•å·²æ¸…ç©º');
                } catch (e) {
                    console.error('æ¸…ç©ºå†å²è®°å½•å¤±è´¥:', e);
                    alert('æ¸…ç©ºå†å²è®°å½•å¤±è´¥');
                }
            }
        }

        // ========== å­—å¹•æ ¼å¼è®¾ç½®ç›¸å…³å‡½æ•° ==========

        // åˆå§‹åŒ–å­—å¹•æ¨¡å¼ç›‘å¬å™¨
        function initSubtitleModeListeners() {
            // ç›‘å¬å­—å¹•æ ¼å¼å˜åŒ–
            document.getElementById('subtitleMode').addEventListener('change', function() {
                toggleHighlightSettings();
                saveSubtitlePreferences();
            });

            // ç›‘å¬æ‰€æœ‰é«˜äº®è®¾ç½®å˜åŒ–
            document.getElementById('highlightColor').addEventListener('change', saveSubtitlePreferences);
            document.getElementById('styleBold').addEventListener('change', saveSubtitlePreferences);
            document.getElementById('styleItalic').addEventListener('change', saveSubtitlePreferences);
            document.getElementById('styleUnderline').addEventListener('change', saveSubtitlePreferences);
        }

        // åˆ‡æ¢é«˜äº®è®¾ç½®æ˜¾ç¤º/éšè—
        function toggleHighlightSettings() {
            const subtitleMode = document.getElementById('subtitleMode').value;
            const highlightSettings = document.getElementById('highlightSettings');

            if (subtitleMode === 'word') {
                highlightSettings.style.display = 'grid';
            } else {
                highlightSettings.style.display = 'none';
            }
        }

        // ä¿å­˜å­—å¹•åå¥½è®¾ç½®
        function saveSubtitlePreferences() {
            try {
                const prefs = {
                    subtitleMode: document.getElementById('subtitleMode').value,
                    highlightColor: document.getElementById('highlightColor').value,
                    styleBold: document.getElementById('styleBold').checked,
                    styleItalic: document.getElementById('styleItalic').checked,
                    styleUnderline: document.getElementById('styleUnderline').checked
                };
                localStorage.setItem('subtitlePreferences', JSON.stringify(prefs));
            } catch (e) {
                console.error('ä¿å­˜å­—å¹•åå¥½è®¾ç½®å¤±è´¥:', e);
            }
        }

        // æ¢å¤å­—å¹•åå¥½è®¾ç½®
        function restoreSubtitlePreferences() {
            try {
                const prefs = localStorage.getItem('subtitlePreferences');
                if (prefs) {
                    const data = JSON.parse(prefs);
                    document.getElementById('subtitleMode').value = data.subtitleMode || 'segment';
                    document.getElementById('highlightColor').value = data.highlightColor || '#00ff00';
                    document.getElementById('styleBold').checked = data.styleBold || false;
                    document.getElementById('styleItalic').checked = data.styleItalic || false;
                    document.getElementById('styleUnderline').checked = data.styleUnderline || false;

                    // è§¦å‘æ˜¾ç¤º/éšè—
                    toggleHighlightSettings();
                }
            } catch (e) {
                console.error('æ¢å¤å­—å¹•åå¥½è®¾ç½®å¤±è´¥:', e);
            }
        }
    </script>
</body>
</html>
